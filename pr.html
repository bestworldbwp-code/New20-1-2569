<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÉ‡∏ö‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠ (PR) | ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container" style="padding: 30px 20px;">
        <!-- Form Section -->
        <div class="card" id="formSection" style="max-width: 900px; margin: 0 auto;">
            <div class="card-header">
                <div class="d-flex align-center justify-between">
                    <a href="index.html" class="btn btn-outline btn-sm">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
                </div>
            </div>

            <div class="card-body">
                <!-- Header -->
                <div class="text-center mb-3">
                    <img id="companyLogo" src="" alt="Company Logo" style="max-height: 80px; margin-bottom: 8px;">
                    <h2 style="margin-bottom: 4px;">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏ö‡∏™‡∏ó‡πå‡πÄ‡∏ß‡∏¥‡∏•‡∏î‡πå ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏û‡∏•‡∏≤‡∏™ ‡∏à‡∏≥‡∏Å‡∏±‡∏î</h2>
                    <h3 class="text-primary">‡πÉ‡∏ö‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠ (Purchase Request)</h3>
                </div>

                <form id="prForm">
                    <!-- Basic Info -->
                    <div class="row row-2">
                        <div class="form-group">
                            <label class="form-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô *</label>
                            <select id="department" class="form-control form-select" required>
                                <option value="" disabled selected>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PR *</label>
                            <input type="text" id="pr_number" class="form-control" required
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô PR-2025/001">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠ *</label>
                        <input type="text" id="requester" class="form-control" required placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                    </div>

                    <div class="form-group">
                        <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *</label>
                        <input type="date" id="required_date" class="form-control" required>
                    </div>

                    <!-- Items Section -->
                    <hr style="margin: 24px 0; border: none; border-top: 2px solid #e2e8f0;">

                    <div class="d-flex align-center justify-between mb-2">
                        <h4>üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
                        <button type="button" class="btn btn-success btn-sm" onclick="addItemRow()">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        </button>
                    </div>

                    <div id="itemsContainer"></div>

                    <!-- Remark & Attachment -->
                    <div class="form-group mt-2">
                        <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea id="header_remark" class="form-control" rows="2"
                            placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                        <input type="file" id="attachment" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary btn-lg w-full mt-2" id="btnSubmit">
                        üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                    </button>
                </form>
            </div>
        </div>

        <!-- Success Section -->
        <div class="card" id="successSection" style="max-width: 600px; margin: 0 auto; display: none;">
            <div class="card-body text-center p-3">
                <div style="font-size: 80px; margin-bottom: 16px;">‚úÖ</div>
                <h2 class="text-success mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</h2>
                <p class="text-muted mb-3">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å‡πÅ‡∏•‡πâ‡∏ß</p>

                <div style="display: flex; flex-direction: column; gap: 12px; max-width: 300px; margin: 0 auto;">
                    <button id="btnPrintPDF" class="btn btn-primary btn-lg">
                        üñ®Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå / ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
                    </button>
                    <a href="index.html" class="btn btn-outline">
                        üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/db.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/logo.js"></script>
    <script>
        let itemCounter = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', async function () {
            await UI.populateDepartmentSelect('department');
            addItemRow();
            // Set logo
            if (typeof LOGO_BASE64 !== 'undefined') {
                document.getElementById('companyLogo').src = LOGO_BASE64;
            }
        });

        // Add item row
        function addItemRow() {
            const container = document.getElementById('itemsContainer');
            const rowId = ++itemCounter;

            const row = document.createElement('div');
            row.className = 'item-row';
            row.id = `item-row-${rowId}`;
            row.innerHTML = `
                <div class="row">
                    <div class="form-group" style="margin-bottom: 0;">
                        <input type="text" class="form-control item-code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <input type="text" class="form-control item-desc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î *" required>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <input type="number" class="form-control item-qty" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô *" required min="1">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <input type="text" class="form-control item-unit" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢">
                    </div>
                </div>
                <div class="remove-btn">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeItemRow(${rowId})">
                        üóëÔ∏è ‡∏•‡∏ö
                    </button>
                </div>
            `;

            container.appendChild(row);
        }

        // Remove item row
        function removeItemRow(id) {
            const row = document.getElementById(`item-row-${id}`);
            if (row) {
                row.remove();
            }
        }

        // Form submit
        document.getElementById('prForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const btn = document.getElementById('btnSubmit');
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

                // Collect items
                const items = [];
                document.querySelectorAll('.item-row').forEach(row => {
                    const desc = row.querySelector('.item-desc').value.trim();
                    if (desc) {
                        items.push({
                            code: row.querySelector('.item-code').value.trim(),
                            description: desc,
                            quantity: row.querySelector('.item-qty').value || '1',
                            unit: row.querySelector('.item-unit').value.trim() || '‡∏ä‡∏¥‡πâ‡∏ô',
                            status: 'pending',
                            remark: ''
                        });
                    }
                });

                if (items.length === 0) {
                    UI.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    return;
                }

                // Upload file if any
                let attachmentUrl = null;
                const fileInput = document.getElementById('attachment');
                if (fileInput.files.length > 0) {
                    btn.innerHTML = '‚è≥ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...';
                    attachmentUrl = await DB.uploadFile(fileInput.files[0], 'pr');
                }

                // Create PR
                btn.innerHTML = '‚è≥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
                const prData = {
                    pr_number: document.getElementById('pr_number').value.trim(),
                    department: document.getElementById('department').value,
                    requester: document.getElementById('requester').value.trim(),
                    required_date: document.getElementById('required_date').value,
                    header_remark: document.getElementById('header_remark').value.trim(),
                    items: items,
                    attachment_url: attachmentUrl,
                    status: 'pending_head'
                };

                const newPR = await DB.createPR(prData);

                // Send email notification to department head
                btn.innerHTML = '‚è≥ ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô...';
                await UI.notifyHeadForPR(prData.department, prData.pr_number, prData.requester);

                // Show success
                document.getElementById('formSection').style.display = 'none';
                document.getElementById('successSection').style.display = 'block';

                document.getElementById('btnPrintPDF').onclick = function () {
                    window.open(`view-pr.html?id=${newPR.id}&mode=original`, '_blank');
                };

                UI.showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', 'success');

            } catch (err) {
                console.error(err);
                UI.showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });
    </script>
</body>

</html>