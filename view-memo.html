<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #525659;
            font-family: 'Sarabun', sans-serif;
            color: #000;
        }

        .no-print {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 24px;
            border-radius: 30px;
            display: flex;
            gap: 12px;
        }

        .no-print button {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-print {
            background: #10b981;
            color: white;
        }

        .btn-close {
            background: #6b7280;
            color: white;
        }

        .page {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 80px auto 40px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h2 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .header h3 {
            font-size: 16px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .memo-info {
            margin-bottom: 30px;
        }

        .info-row {
            display: flex;
            margin-bottom: 10px;
        }

        .info-row .label {
            width: 80px;
            font-weight: 600;
        }

        .info-row .value {
            flex: 1;
            border-bottom: 1px dotted #000;
            padding-left: 10px;
        }

        .info-row-double {
            display: flex;
        }

        .info-row-double .part {
            flex: 1;
            display: flex;
        }

        .content-box {
            min-height: 350px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            white-space: pre-wrap;
            line-height: 1.8;
            text-align: justify;
            margin-bottom: 30px;
        }

        .attachment-box {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 30px;
        }

        .attachment-box a {
            color: #4361ee;
            text-decoration: none;
        }

        .signature-area {
            display: flex;
            justify-content: space-around;
            margin-top: 50px;
        }

        .sign-box {
            text-align: center;
            width: 150px;
        }

        .sign-box .label {
            font-weight: 600;
            margin-bottom: 50px;
        }

        .sign-box .line {
            border-bottom: 1px dotted #000;
            margin-bottom: 5px;
        }

        .sign-box .name {
            font-size: 12px;
            min-height: 30px;
        }

        .text-success {
            color: #10b981;
        }

        @media print {
            body {
                background: white;
            }

            .no-print {
                display: none !important;
            }

            .page {
                box-shadow: none;
                margin: 0;
            }
        }
    </style>
</head>

<body>
    <div class="no-print">
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF</button>
        <button class="btn-close" onclick="window.close()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
    </div>

    <div class="page" id="pageContent">
        <div class="text-center" style="padding: 100px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/db.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/logo.js"></script>
    <script>
        async function loadMemo() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const isPreview = params.get('preview') === 'true';

            let memo;

            // Handle Preview Mode
            if (isPreview) {
                const previewData = sessionStorage.getItem('memo_preview_data');
                if (!previewData) {
                    document.getElementById('pageContent').innerHTML = '<p style="text-align: center; padding: 100px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</p>';
                    return;
                }
                memo = JSON.parse(previewData);
                document.title = '(Preview) ' + document.title;
                const ribbon = document.createElement('div');
                ribbon.className = 'no-print';
                ribbon.style.cssText = 'position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: #ffc107; color: #000; padding: 5px 20px; border-radius: 20px; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.2); pointer-events: none;';
                ribbon.innerHTML = '‚ö†Ô∏è ‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (Preview Mode)';
                document.body.appendChild(ribbon);
            } else if (!id) {
                document.getElementById('pageContent').innerHTML = '<p style="text-align: center; padding: 100px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                return;
            } else {
                // Load from DB
                try {
                    memo = await DB.getMemoById(id);
                } catch (err) {
                    console.error(err);
                    document.getElementById('pageContent').innerHTML = '<p style="text-align: center; padding: 100px;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message + '</p>';
                    return;
                }
            }

            try {
                const memoDate = UI.formatDate(memo.date);
                const headApproved = memo.status !== 'pending_head' && memo.status !== 'pending' && memo.status !== 'preview';
                const managerApproved = memo.status === 'processed';

                const attachmentHtml = memo.attachment_url
                    ? `<div class="attachment-box"><strong>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö:</strong> <a href="${memo.attachment_url}" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</a></div>`
                    : '';

                document.getElementById('pageContent').innerHTML = `
                    <div class="header">
                        ${typeof LOGO_BASE64 !== 'undefined' ? `<img src="${LOGO_BASE64}" alt="Company Logo" style="max-height: 80px; margin-bottom: 8px;">` : ''}
                        <h2>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏ö‡∏™‡∏ó‡πå‡πÄ‡∏ß‡∏¥‡∏•‡∏î‡πå ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏û‡∏•‡∏≤‡∏™ ‡∏à‡∏≥‡∏Å‡∏±‡∏î</h2>
                        <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h3>
                    </div>
                    
                    <div class="memo-info">
                        <div class="info-row">
                            <span class="label">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</span>
                            <span class="value">${memo.from_dept}</span>
                        </div>
                        <div class="info-row-double">
                            <div class="part">
                                <span class="label">‡∏ó‡∏µ‡πà</span>
                                <span class="value" style="flex: 1; border-bottom: 1px dotted #000; padding-left: 10px;">${memo.memo_no}</span>
                            </div>
                            <div class="part">
                                <span class="label" style="text-align: right; padding-right: 10px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
                                <span class="value" style="flex: 1; border-bottom: 1px dotted #000; padding-left: 10px;">${memoDate}</span>
                            </div>
                        </div>
                        <div class="info-row">
                            <span class="label">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</span>
                            <span class="value">${memo.subject}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                            <span class="value" style="font-weight: 600;">${memo.to_dept}</span>
                        </div>
                    </div>
                    
                    <div class="content-box">${memo.content}</div>
                    
                    ${attachmentHtml}
                    
                    <div class="signature-area">
                        <div class="sign-box">
                            <div class="label">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥</div>
                            <div class="name" style="color: #4361ee; font-weight: 600;">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏Å${memo.from_dept}</div>
                            <div class="line"></div>
                        </div>
                        <div class="sign-box">
                            <div class="label">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</div>
                            <div class="name">
                                ${headApproved
                        ? '( ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å )<br><span class="text-success" style="font-size: 11px;">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>'
                        : '( ........................... )'}
                            </div>
                            <div class="line"></div>
                        </div>
                        <div class="sign-box">
                            <div class="label">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á</div>
                            <div class="name">
                                ${managerApproved
                        ? '( ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ )<br><span class="text-success" style="font-size: 11px;">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>'
                        : '( ........................... )'}
                            </div>
                            <div class="line"></div>
                        </div>
                    </div>
                `;

            } catch (err) {
                console.error(err);
                document.getElementById('pageContent').innerHTML = '<p style="text-align: center; padding: 100px;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message + '</p>';
            }
        }

        window.onload = loadMemo;
    </script>
</body>

</html>