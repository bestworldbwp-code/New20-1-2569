<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Memo) | ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container" style="padding: 30px 20px;">
        <div class="card" style="max-width: 900px; margin: 0 auto;">
            <div class="card-header">
                <div class="d-flex align-center justify-between">
                    <a href="index.html" class="btn btn-outline btn-sm">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
                </div>
            </div>

            <div class="card-body">
                <!-- Header -->
                <div class="text-center mb-3">
                    <img id="companyLogo" src="" alt="Company Logo" style="max-height: 80px; margin-bottom: 8px;">
                    <h2 style="margin-bottom: 4px;">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏ö‡∏™‡∏ó‡πå‡πÄ‡∏ß‡∏¥‡∏•‡∏î‡πå ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏û‡∏•‡∏≤‡∏™ ‡∏à‡∏≥‡∏Å‡∏±‡∏î</h2>
                    <h3 class="text-success">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Memo)</h3>
                </div>

                <form id="memoForm">
                    <div class="row row-2">
                        <div class="form-group">
                            <label class="form-label">‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (From) *</label>
                            <select id="from_dept" class="form-control form-select" required>
                                <option value="" disabled selected>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ *</label>
                            <input type="text" id="memo_no" class="form-control" required
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô MEMO-2025/001">
                        </div>
                    </div>

                    <div class="row row-2">
                        <div class="form-group">
                            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà *</label>
                            <input type="date" id="memo_date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (To) *</label>
                            <input type="text" id="to_dept" class="form-control" required
                                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ‡∏´‡∏£‡∏∑‡∏≠ ‡πÅ‡∏ú‡∏ô‡∏Å...">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (Subject) *</label>
                        <input type="text" id="subject" class="form-control" required placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á">
                    </div>

                    <div class="form-group">
                        <label class="form-label">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î *</label>
                        <textarea id="content" class="form-control" rows="10" required
                            placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                        <input type="file" id="attachment" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                    </div>

                    <div class="d-flex gap-2 mt-2">
                        <button type="button" class="btn btn-info btn-lg w-full" onclick="previewMemo()">
                            üëÄ ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (Preview)
                        </button>
                        <button type="submit" class="btn btn-success btn-lg w-full" id="btnSubmit">
                            üöÄ ‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/db.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/logo.js"></script>
    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', async function () {
            await UI.populateDepartmentSelect('from_dept');
            document.getElementById('memo_date').value = UI.getTodayDate();
            // Set logo
            if (typeof LOGO_BASE64 !== 'undefined') {
                document.getElementById('companyLogo').src = LOGO_BASE64;
            }
        });

        // Form submit
        document.getElementById('memoForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const btn = document.getElementById('btnSubmit');
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

                // Upload file if any
                let attachmentUrl = null;
                const fileInput = document.getElementById('attachment');
                if (fileInput.files.length > 0) {
                    btn.innerHTML = '‚è≥ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...';
                    attachmentUrl = await DB.uploadFile(fileInput.files[0], 'memo');
                }

                // Create Memo
                btn.innerHTML = '‚è≥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
                const memoData = {
                    memo_no: document.getElementById('memo_no').value.trim(),
                    date: document.getElementById('memo_date').value,
                    from_dept: document.getElementById('from_dept').value,
                    to_dept: document.getElementById('to_dept').value.trim(),
                    subject: document.getElementById('subject').value.trim(),
                    content: document.getElementById('content').value.trim(),
                    attachment_url: attachmentUrl,
                    status: 'pending_head'
                };

                const newMemo = await DB.createMemo(memoData);

                // Send email notification
                btn.innerHTML = '‚è≥ ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô...';
                await UI.notifyHeadForMemo(memoData.from_dept, memoData.memo_no, memoData.subject);

                UI.showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', 'success');

                if (confirm('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Memo ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!\n\n‡∏Å‡∏î "‡∏ï‡∏Å‡∏•‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£\n‡∏Å‡∏î "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å')) {
                    window.open(`view-memo.html?id=${newMemo.id}`, '_blank');
                }
                window.location.href = 'index.html';

            } catch (err) {
                console.error(err);
                UI.showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // Preview Function
        async function previewMemo() {
            // Get form values
            const memoData = {
                memo_no: document.getElementById('memo_no').value.trim() || '-',
                date: document.getElementById('memo_date').value || '-',
                from_dept: document.getElementById('from_dept').value || '-',
                to_dept: document.getElementById('to_dept').value.trim() || '-',
                subject: document.getElementById('subject').value.trim() || '-',
                content: document.getElementById('content').value.trim() || '-',
                status: 'preview' // Flag for preview
            };

            // Handle file for preview (create blob URL)
            const fileInput = document.getElementById('attachment');
            if (fileInput.files.length > 0) {
                memoData.attachment_url = URL.createObjectURL(fileInput.files[0]);
                memoData.attachment_name = fileInput.files[0].name;
            }

            // Save to session
            sessionStorage.setItem('memo_preview_data', JSON.stringify(memoData));

            // Open window
            window.open('view-memo.html?preview=true', '_blank');
        }
    </script>
</body>

</html>