<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Diagnostic Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            padding: 40px;
            background: #f8fafc;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            color: #1e293b;
            margin-top: 0;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .success {
            background: #dcfce7;
            color: #166534;
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
        }

        .info {
            background: #e0f2fe;
            color: #075985;
        }

        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }

        button:hover {
            background: #1d4ed8;
        }

        pre {
            background: #1e293b;
            color: #f8fafc;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>üîç Database Diagnostic Tool</h1>
        <div id="results">
            <div class="status info">Ready to test connection...</div>
        </div>
        <button onclick="runTests()">‚ñ∂ Run Diagnostics</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>

    <script>
        const { createClient } = supabase;
        const db = createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);

        function log(message, type = 'info') {
            const el = document.createElement('div');
            el.className = `status ${type}`;
            el.textContent = message;
            document.getElementById('results').appendChild(el);
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function logData(data) {
            const el = document.createElement('pre');
            el.textContent = JSON.stringify(data, null, 2);
            document.getElementById('results').appendChild(el);
        }

        async function runTests() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            log('Starting diagnostics...', 'info');

            try {
                // 1. Check Config
                log('1. Checking Configuration...', 'info');
                if (!CONFIG.supabaseUrl || !CONFIG.supabaseKey) {
                    throw new Error('Supabase Config missing');
                }
                log('Configuration OK', 'success');

                // 2. Test Connection (Select)
                log('2. Testing Read Access (SELECT)...', 'info');
                const { data: selectData, error: selectError } = await db
                    .from('petty_cash_requests')
                    .select('count', { count: 'exact', head: true });

                if (selectError) {
                    throw new Error(`Read Access Failed: ${selectError.message}`);
                }
                log(`Read Access OK. Total rows: ${selectData?.length ?? '?'} (Count query success)`, 'success');

                // 3. Test Insert (RLS Check)
                log('3. Testing Write Access (INSERT with Return)...', 'info');
                const testData = {
                    request_no: 'TEST-' + Date.now(),
                    department: 'IT',
                    requester: 'Test System',
                    request_date: new Date().toISOString().split('T')[0],
                    total_amount: 100,
                    status: 'cancelled' // Auto cancel
                };

                const { data: insertData, error: insertError } = await db
                    .from('petty_cash_requests')
                    .insert([testData])
                    .select();

                if (insertError) {
                    throw new Error(`Insert Failed: ${insertError.message}`);
                }

                if (!insertData || insertData.length === 0) {
                    throw new Error('Insert success but RETURNED NO DATA. This confirms RLS "WITH CHECK" issue.');
                }

                log('Write Access OK. Data returned successfully.', 'success');
                logData(insertData[0]);

                // 4. Test ID
                if (!insertData[0].id) {
                    throw new Error('Returned data has no ID.');
                }
                log(`ID Generated: ${insertData[0].id}`, 'success');

                log('‚úÖ ALL TESTS PASSED! Database is ready.', 'success');

                // Cleanup
                await db.from('petty_cash_requests').delete().eq('id', insertData[0].id);

            } catch (err) {
                log(`‚ùå TEST FAILED: ${err.message}`, 'error');
                if (err.message.includes('RLS')) {
                    log('üí° SUGGESTION: User needs to run the SQL fix script.', 'info');
                }
            }
        }
    </script>
</body>

</html>